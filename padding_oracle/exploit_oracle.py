from client import send_oracle_protocol
from crypto_util import encrypt, pad, BLOCK_SIZE
import time
def assemble_byte_string(byte_string_start, byte_string_end):
    res = []
    for i in range(256):
        res.append(byte_string_start+i.to_bytes(1, byteorder='little')+byte_string_end)
    return res

if __name__ == "__main__":
    print(pad(b'djbernstein'))
    ct = encrypt(b'\x12\x34'*8, pad(b'djbernstein'))
    ct = 0x566b0c7206dbb19efa9b296696af2652.to_bytes(16, byteorder='little')
    print(ct)
    pt = [0]*16
    iv = b'\x00'*15
    for i in range(BLOCK_SIZE):
        current_padding = [(block^(i+1)).to_bytes(1, byteorder='little') for block in pt[BLOCK_SIZE-i:]]
        print(current_padding)
        iv_list = assemble_byte_string(iv[:BLOCK_SIZE-i],b''.join(current_padding))
        print(iv_list[0],iv_list[48])
        response = send_oracle_protocol("127.0.0.1", 3874, 256, ct, iv_list)
        for j in range(len(response)):
            if response[j]==1:
                print("Candidate: " + str(j))
                candidate = j
        pt[BLOCK_SIZE-i-1] = candidate^i
        time.sleep(1)
    print(pt)